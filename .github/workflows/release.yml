name: Build and Release

on:
  push:
    tags:
      - 'v*' # Trigger only on tags like v1.0, v2.3.4, etc.
      
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual run'
        required: true
        default: 'Manual test run'

permissions:
  contents: write

jobs:
  # Job 1: Build Linux Static + WASM
  build-linux-and-wasm:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get -y install podman

      - name: Install QEMU (for ARM64 support)
        uses: docker/setup-qemu-action@v3

      - name: Build WASM
        run: make build_wasm

      - name: Build Linux Static (x86_64)
        run: make build_linux_static ARCHl=x86_64

      - name: Build Linux Static (ARM64 / Raspberry Pi)
        run: |
          # Pass the --platform flag to podman to trigger QEMU emulation
          # We define ARCHl=aarch64 so the output file is named correctly
          make build_linux_static \
            PODMAN_RUN_ALPINE="podman run --rm --platform linux/arm64 -v $(pwd):/data -w /data/src alpine:latest" \
            ARCHl=aarch64

      - name: Build Linux Static (ARM32 / Pi Zero)
        run: |
          # --platform linux/arm/v7 targets 32-bit ARM
          # We manually set ARCHl=armv7l so the file is named 'diluvium_linux_static_armv7l'
          make build_linux_static \
            PODMAN_RUN_ALPINE="podman run --rm --platform linux/arm/v7 -v $(pwd):/data -w /data/src alpine:latest" \
            ARCHl=armv7l

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-wasm-artifacts
          path: dist/*

  # Job 2: Build macOS (Native)
  build-macos:
    strategy:
        matrix:
          os: [macos-latest, macos-13]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: brew install lua readline

      - name: Build macOS Native
        run: |
          # Help clang find readline if it's in a non-standard brew location
          export CPATH="$(brew --prefix readline)/include:$CPATH"
          export LIBRARY_PATH="$(brew --prefix readline)/lib:$LIBRARY_PATH"
          make build_platform

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts-${{ matrix.os }}
          path: dist/*

  # Job 3: Build Windows (via MSYS2)
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSYS2
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: >-
            git
            make
            mingw-w64-x86_64-gcc

      - name: Build Windows
        shell: msys2 {0}
        run: |
          # We manually set the variables to control the ugly default filename
          # Default MSYS uname is long like "mingw64_nt-10.0..."
          make build_platform UNAME_Sl=windows ARCHl=x86_64
          
          # Optional: Verify it built and rename if needed
          ls -l dist/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: dist/*          

  # Job 4: Create Release
  release:
    needs: [build-linux-and-wasm, build-macos, build-windows]
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: "*-artifacts"
          merge-multiple: true
          path: release_dist

      - name: Generate Release Notes
        run: |
          # Create a temporary file with the table
          echo "## ðŸ“¥ Download Guide" > release_notes.md
          echo "" >> release_notes.md
          echo "| Platform | File to Download | Notes |" >> release_notes.md
          echo "| :--- | :--- | :--- |" >> release_notes.md
          echo "| **Linux (Standard)** | \`diluvium_linux_static_x86_64\` | Works on Ubuntu, Fedora, CentOS, Arch |" >> release_notes.md
          echo "| **Raspberry Pi 3/4/5** | \`diluvium_linux_static_aarch64\` | 64-bit OS only |" >> release_notes.md
          echo "| **macOS (M1/M2/M3)** | \`diluvium_darwin_arm64\` | Apple Silicon |" >> release_notes.md
          echo "| **Windows** | \`diluvium_windows_x86_64.exe\` | Standard 64-bit Windows |" >> release_notes.md
          echo "" >> release_notes.md
          echo "---" >> release_notes.md
          echo "" >> release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: release_dist/*
          body_path: release_notes.md
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}